# 通用API

本节介绍两个API的写程序是的通用操作：如何注册表、如何查询表、如何生成表。



# 两个planners的区别

Blink 把批处理工作视为流处理的一种特殊情况，因此，不支持Talbe和Dataset之间的转换，批处理工作也不会转换到DataSet程序。批处理工作可以转换到SataStream程序。

Blink不支持BatchTableSource，请使用

# 程序结构

```java
// create a TableEnvironment for specific planner batch or streaming
TableEnvironment tableEnv = ...; // see "Create a TableEnvironment" section

// create a Table
tableEnv.connect(...).createTemporaryTable("table1");
// register an output Table
tableEnv.connect(...).createTemporaryTable("outputTable");

// create a Table object from a Table API query
Table tapiResult = tableEnv.from("table1").select(...);
// create a Table object from a SQL query
Table sqlResult  = tableEnv.sqlQuery("SELECT ... FROM table1 ... ");

// emit a Table API result Table to a TableSink, same for SQL result
tapiResult.insertInto("outputTable");

// execute
tableEnv.execute("java_job");
```

# Create a TableEnvironment

TableEnvironment是集成table api和sql的核心，他负责：

- 注册表到内部catalog中
- 注册catalogs
- 加载可插拔模块 pluggable modules
- 执行sql查询
- 注册用户自定义函数
- 转化datastream或dataset到table
- 持有ExecutionEnvironment或者StreamExecutionEnvironment的引用

表必须绑定到指定的TableEnvironment，不同的TableEnvironment中的表不能组合查询，如不能join 、union。

TableEnvironment的创建是通过调用 `BatchTableEnvironment.create()` 或者 `StreamTableEnvironment.create()`静态方法。创建时，需要依赖`StreamExecutionEnvironment`或者 `ExecutionEnvironment`，并且可以有选择的指定`TableConfig`。TableConfig可以配置TableEnvironment运行参数也可以优化自定义查询和事务的性能（后续有介绍）。

```
// **********************
// FLINK STREAMING QUERY
// **********************
import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;
import org.apache.flink.table.api.EnvironmentSettings;
import org.apache.flink.table.api.java.StreamTableEnvironment;

EnvironmentSettings fsSettings = EnvironmentSettings.newInstance().useOldPlanner().inStreamingMode().build();
StreamExecutionEnvironment fsEnv = StreamExecutionEnvironment.getExecutionEnvironment();
StreamTableEnvironment fsTableEnv = StreamTableEnvironment.create(fsEnv, fsSettings);
// or TableEnvironment fsTableEnv = TableEnvironment.create(fsSettings);

// ******************
// FLINK BATCH QUERY
// ******************
import org.apache.flink.api.java.ExecutionEnvironment;
import org.apache.flink.table.api.java.BatchTableEnvironment;

ExecutionEnvironment fbEnv = ExecutionEnvironment.getExecutionEnvironment();
BatchTableEnvironment fbTableEnv = BatchTableEnvironment.create(fbEnv);

// **********************
// BLINK STREAMING QUERY
// **********************
import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;
import org.apache.flink.table.api.EnvironmentSettings;
import org.apache.flink.table.api.java.StreamTableEnvironment;

StreamExecutionEnvironment bsEnv = StreamExecutionEnvironment.getExecutionEnvironment();
EnvironmentSettings bsSettings = EnvironmentSettings.newInstance().useBlinkPlanner().inStreamingMode().build();
StreamTableEnvironment bsTableEnv = StreamTableEnvironment.create(bsEnv, bsSettings);
// or TableEnvironment bsTableEnv = TableEnvironment.create(bsSettings);

// ******************
// BLINK BATCH QUERY
// ******************
import org.apache.flink.table.api.EnvironmentSettings;
import org.apache.flink.table.api.TableEnvironment;

EnvironmentSettings bbSettings = EnvironmentSettings.newInstance().useBlinkPlanner().inBatchMode().build();
TableEnvironment bbTableEnv = TableEnvironment.create(bbSettings);
```



